# =====================================================
# Dockerfile for Web Application
# Multi-stage build for optimized production image
# =====================================================

# --- Stage 1: Builder ---
FROM node:22-alpine AS builder
WORKDIR /app

# Enable pnpm
RUN corepack enable

# Copy monorepo config
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./

# Copy package manifests
COPY packages/types/package.json packages/types/
COPY packages/design-tokens/package.json packages/design-tokens/
COPY packages/ui/package.json packages/ui/
COPY packages/api-client/package.json packages/api-client/
COPY packages/auth/package.json packages/auth/
COPY packages/state/package.json packages/state/
COPY packages/analytics/package.json packages/analytics/
COPY packages/websocket/package.json packages/websocket/
COPY packages/offline-store/package.json packages/offline-store/
COPY apps/web/package.json apps/web/

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source code
COPY packages ./packages
COPY apps/web ./apps/web
COPY tsconfig.base.json ./

# Build
RUN pnpm build

# --- Stage 2: Runner ---
FROM nginx:alpine AS runner

# Copy build artifacts from builder
COPY --from=builder /app/apps/web/dist /usr/share/nginx/html

# Copy custom Nginx config (optional, use default for now)
# COPY infrastructure/docker/nginx.conf /etc/nginx/conf.d/default.conf

# Expose port
EXPOSE 80

# Start Nginx
CMD ["nginx", "-g", "daemon off;"]
